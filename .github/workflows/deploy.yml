name: Deploy Guestbook

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > $HOME/.kube/config.github.uus
          chmod 600 $HOME/.kube/config.github.uus
          export KUBECONFIG=$HOME/.kube/config.github.uus

      - name: Ensure guestbook namespace exists
        run: |
          kubectl create namespace guestbook || true

      - name: Deploy Redis
        run: |
          kubectl -n guestbook apply -f deploy/redis-master.yaml
          kubectl -n guestbook apply -f deploy/redis-slave.yaml

      - name: Deploy Frontend
        run: |
          kubectl -n guestbook apply -f deploy/frontend.yaml

      - name: Deploy Ingress
        run: |
          kubectl -n guestbook apply -f deploy/frontend-ingress.yaml

      - name: Wait for rollouts
        run: |
          kubectl -n guestbook rollout status deployment/frontend --timeout=120s
          kubectl -n guestbook rollout status deployment/redis-master --timeout=120s
          kubectl -n guestbook rollout status deployment/redis-slave --timeout=120s

      - name: Smoke test via Ingress
        run: |
          HOST=$(kubectl -n guestbook get ingress frontend-ingress -o jsonpath='{.spec.rules[0].host}')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Host: $HOST" http://127.0.0.1)

          echo "Ingress status code: $STATUS"

          if [ "$STATUS" != "200" ]; then
            echo "Smoke test failed â€” rolling back frontend"
            kubectl -n guestbook rollout undo deployment/frontend
            exit 1
          fi

          echo "Smoke test passed!"